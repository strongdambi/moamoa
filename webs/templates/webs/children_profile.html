{% extends 'webs/base.html' %}

{% load static %}

{% block title %}모아모아 - 오늘의 용돈기입장{% endblock %}

{% block content %}
<div class="container">
  <!-- 아이 환영 메시지 -->
  <div class="text-center mt-3">
    <h2 id="child-greeting">아이의 이름을 불러옵니다...</h2>
  </div>

  <!-- 용돈기입장 섹션 -->
  <div class="spending-log mt-4 p-3" style="background-color: #FFF4DB; border-radius: 10px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">용돈기입장</h5>
      <select class="form-select w-auto" style="background-color: rgb(255, 252, 241); border-color: #FFCD00;">
        <option>24년 8월</option>
      </select>
    </div>
    <table class="table text-center">
      <thead>
        <tr>
          <th>날짜</th>
          <th>내용</th>
          <th>금액</th>
          <th>남은 돈</th>
        </tr>
      </thead>
      <tbody id="diary-table-body">
        <!-- 데이터가 여기에 추가됩니다 -->
      </tbody>
    </table>
    <div class="text-center">
      <a href="#" class="text-muted">더보기</a>
    </div>
  </div>

  <!-- 응원 메시지 -->
  <div class="encouragement mt-4 p-3" style="background-color: #FFFCD6; border-radius: 10px;">
    <h5>부모님이 보내신 응원의 메시지</h5>
    <p>비어있음</p>
  </div>
</div>

<!-- 하단 네비게이션 -->
<div class="bottom-nav text-center">
  <a href="webs/chatbot/" class="nav-btn">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="white" class="bi bi-plus-lg" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v6.5H15a.5.5 0 0 1 0 1H8.5v6.5a.5.5 0 0 1-1 0V9H1a.5.5 0 0 1 0-1h6.5V1.5a.5.5 0 0 1 .5-.5z"/>
    </svg>
  </a>
</div>
{% endblock %}

{% block extra_head %}
<style>
  #child-greeting {
    margin: 30px;
  }
  .encouragement, .spending-log {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  /* 하단 내비게이션 */
  .bottom-nav {
    position: absolute;
    bottom: 0px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    background-color: #FFF4DB;
    height: 50px;
    border-top: 5px solid #FFCD00;
  }

  .nav-btn {
    background-color: #FFCD00;
    border-radius: 50%;
    padding: 10px;
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: -40px; /* 버튼이 살짝 떠 있도록 설정 */
  }

  /* #app 높이 설정 */
  #app {
    position: relative;
    min-height: 100vh;
    padding-bottom: 60px; /* 내비게이션 공간 확보 */
  }
  .expense {
    color: red !important;  /* 지출일 경우 빨간색 */
  }
  .income {
    color: blue !important; /* 수입일 경우 파란색 */
  }
</style>
{% endblock %}

{% block extra_script %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // URL에서 자녀 ID 추출하기
    const childId = window.location.pathname.split("/")[3];  // URL에서 자녀 ID 추출
    const year = new Date().getFullYear();
    const month = new Date().getMonth() + 1;
    const accessToken = localStorage.getItem('child_access_token');

    // 자녀 정보 가져오기
    fetch(`http://localhost:8000/api/v1/accounts/children/${childId}/`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then((response) => response.json())
    .then((data) => {
        const greeting = document.getElementById('child-greeting');
        greeting.textContent = `${data.first_name} 반가워!`;  // 자녀 이름 표시
    })
    .catch((error) => {
        console.error('프로필을 불러올 수 없습니다.:', error);
    });

    // 월별 용돈기입장 가져오기
    fetch(`http://localhost:8000/api/v1/diary/${childId}/${year}/${month}/`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then((response) => response.json())
    .then((data) => {
        const diaryTableBody = document.getElementById('diary-table-body');
        diaryTableBody.innerHTML = ''; 
        
        data.diary.forEach(entry => {
            // 거래 유형에 따른 기호 추가
            const sign = entry.transaction_type === '지출' ? '-' : '+';
            const formattedAmount = `${sign} ${parseInt(entry.amount).toLocaleString()}원`;  // 금액을 정수로 변환하고 3자리마다 콤마 추가
            const amountClass = entry.transaction_type === '지출' ? 'expense' : 'income';  // 지출일 경우 'expense' 클래스를, 수입일 경우 'income' 클래스를 사용

            const row = `
            <tr>
                <td>${entry.today}</td>  <!-- 날짜 필드 -->
                <td>${entry.diary_detail}</td>  <!-- 내용 필드 -->
                <td class="${amountClass}">${formattedAmount}</td>  <!-- 금액 필드 (클래스 적용) -->
                <td>${parseInt(entry.remaining_amount).toLocaleString()}원</td>  <!-- 남은 돈 필드 -->
            </tr>`;
            diaryTableBody.insertAdjacentHTML('beforeend', row);
        });
    })
    .catch((error) => {
        console.error('용돈기입장을 불러올 수 없습니다.', error);
    });
});
</script>
{% endblock %}