{% extends 'webs/base.html' %}

{% load static %}

{% block title %}모아모아-챗봇{% endblock %}

{% block content %}

<div class="container-fluid d-flex flex-column h-100 p-0">
  <div class="chat-history flex-grow-1 overflow-auto" id="chat-history"></div>
  <div class="chat-input-container py-3 px-4 d-flex align-items-center shadow-sm" id="chat-input-container">
    <input type="hidden" id="childPk" value="{{ child_pk }}">
    <input type="hidden" id="userId" value="{{ user_id }}">
    <input type="text" id="chat-input" placeholder="입력">
    <button id="send-button">입력</button>
</div>
</div>
{% endblock %}

{% block extra_head %}
<style>

    body {
      background-color: #F9F4E2;
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
    }
  
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
  
    .chat-history {
      flex-grow: 1;
      overflow-y: auto;
      padding-bottom: 20px;
      
    }
  
    .chat-bubble {
      border-radius: 20px;
      padding: 15px;
      margin-bottom: 10px;
      display: inline-block;
      font-size: 16px;
      max-width: 80%;
    }
  
    .chat-left {
      background-color: #FFF3D6;
      float: left;
      clear: both;
    }
  
    .chat-right {
      background-color: #DFF2D8;
      float: right;
      clear: both;
    }
  
    .chat-input-container {
      background-color: #F9F4E2;
      padding: 10px 0;
      display: flex;
      align-items: center;
      border-top: 1px solid #ddd;
    }
  
    #chat-input {
      flex-grow: 1;
      border: 2px solid #6D9C48;
      border-radius: 25px;
      padding: 10px;
      margin-right: 10px;
    }
  
    #send-button {
      background-color: #FFCD00;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-size: 16px;
    }
  
    .timestamp {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    .chat-history {
      overflow-y: auto;
  }

  </style>
{% endblock %}

{% block extra_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
<script>
  
  
  const chatHistory = document.getElementById('chat-history');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('send-button');

function getChildPkFromUrl() {
  const pathSegments = window.location.pathname.split('/');
  return pathSegments[pathSegments.length - 2];
}

// 채팅 기록 불러오기
function loadChatHistory() {
  
  const childPk = getChildPkFromUrl();
  console.log(childPk)
  fetch(`/api/v1/diary/chat/messages/${childPk}/`, {
      method: 'GET',
      credentials: 'include',
      headers: {
          'Content-Type': 'application/json',
      },
  })
  .then(response => {
      if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
  })
  .then(data => {
      console.log(data);
      chatHistory.innerHTML = '';


      if (data && Array.isArray(data.response)) {
          data.response.forEach(message => {
              const messageElement = document.createElement('div');
              messageElement.classList.add('chat-bubble');
              messageElement.classList.add(message.type === 'USER' ? 'chat-right' : 'chat-left');

              const formattedContent = message.content.replace(/\n/g, '<br>'); // 추가 부분
              
              messageElement.innerHTML = DOMPurify.sanitize(
                `${message.type === 'USER' ? message.username : message.ai_name}: ${formattedContent}`
            );

              //messageElement.textContent = `${message.type === 'USER' ? message.username : message.ai_name}: ${formattedContent}`;
              
              chatHistory.appendChild(messageElement);
          });
          chatHistory.scrollTop = chatHistory.scrollHeight;
      } else {
          console.error('Expected an array in `data.response` but got:', data.response);
      }
  })
  .catch(error => {
      console.error('Fetch error:', error);
  });
}

// 메시지 전송
function sendMessage() {
  const message = chatInput.value.trim();
  if (message) {
      const childPk = getChildPkFromUrl();
      fetch('/api/v1/diary/chat/', {
        credentials: 'include',
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message, child_pk: childPk })
      })
      .then(response => response.json())
      .then(data => {
          chatInput.value = '';
          loadChatHistory();
      })
      .catch(error => console.error('Error:', error));
  }
}

// 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', function() {
  const sendButton = document.getElementById('send-button');
  const chatInput = document.getElementById('chat-input');

  sendButton.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
          sendMessage();
      }
  });

  // 초기 로드
  loadChatHistory();

  // 주기적으로 채팅 기록 새로고침 (옵션)
  setInterval(loadChatHistory, 3000);  // 5초마다 새로고침
});

function ChatHistoryHeight() {
    const chatInputContainer = document.getElementById('chat-input-container');
    const chatHistory = document.getElementById('chat-history');
    const chatInputHeight = chatInputContainer.offsetHeight;
    chatHistory.style.height = `calc(90vh - ${chatInputHeight}px)`;
  }
  window.addEventListener('load', ChatHistoryHeight);
  window.addEventListener('resize', ChatHistoryHeight);
</script>
{% endblock %}