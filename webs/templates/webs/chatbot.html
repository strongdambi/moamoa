{% extends 'webs/base.html' %}

{% load static %}

{% block title %}모아모아-챗봇{% endblock %}

{% block content %}
<div class="container">
  <div class="chat-history" id="chat-history"></div>

  <!-- Chat Input Container -->
  <div class="chat-input-container">
    <input type="hidden" id="childPk" value="{{ child_pk }}">
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}"> <!-- CSRF 토큰 추가 -->
    <input type="text" id="chat-input" placeholder="메시지를 입력하세요">
    <button id="send-button">입력</button>
  </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
  body {
    background-color: #F9F4E2;
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    height: 100vh;
  }

  .chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 20px;
    box-sizing: border-box;
  }

  .chat-history {
    flex-grow: 1;
    overflow-y: auto;
    padding-bottom: 20px;
  }

  .chat-bubble {
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 10px;
    display: inline-block;
    font-size: 16px;
    max-width: 80%;
  }

  .chat-left {
    background-color: #FFF3D6;
    float: left;
    clear: both;
  }

  .chat-right {
    background-color: #DFF2D8;
    float: right;
    clear: both;
  }

  .chat-input-container {
    background-color: #F9F4E2;
    padding: 10px 0;
    display: flex;
    align-items: center;
    border-top: 1px solid #ddd;
  }

  #chat-input {
    flex-grow: 1;
    border: 2px solid #6D9C48;
    border-radius: 25px;
    padding: 10px;
    margin-right: 10px;
  }

  #send-button {
    background-color: #FFCD00;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 16px;
  }

  .timestamp {
    font-size: 12px;
    color: #888;
    margin-top: 5px;
  }
</style>
{% endblock %}

{% block extra_script %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const childPk = document.getElementById('childPk').value;
    const csrfToken = document.getElementById('csrf_token').value;

    // 채팅 기록 불러오기
    function loadChatHistory() {
      fetch(`/api/v1/diary/chat/messages/${childPk}/`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        credentials: 'include'  // 인증 정보를 포함하여 요청
      })
      .then(response => response.json())
      .then(data => {
        chatHistory.innerHTML = '';

        if (data && Array.isArray(data.response)) {
          data.response.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-bubble');
            messageElement.classList.add(message.type === 'USER' ? 'chat-right' : 'chat-left');
            messageElement.textContent = `${message.type === 'USER' ? message.username : message.ai_name}: ${message.content}`;
            chatHistory.appendChild(messageElement);
          });
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
      })
      .catch(error => console.error('Error:', error));
    }

    // 메시지 전송
    function sendMessage() {
      const message = chatInput.value.trim();
      if (message) {
        fetch(`/api/v1/diary/chat/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          credentials: 'include',
          body: JSON.stringify({
            message: message,
            child_pk: childPk
          })
        })
        .then(response => response.json())
        .then(data => {
          chatInput.value = '';
          loadChatHistory();
        })
        .catch(error => console.error('Error:', error));
      }
    }

    // 이벤트 리스너 설정
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // 페이지 로드 시 채팅 기록 불러오기
    loadChatHistory();

    // 주기적으로 채팅 기록 새로고침
    setInterval(loadChatHistory, 5000);  // 5초마다 새로고침
  });
</script>
{% endblock %}
